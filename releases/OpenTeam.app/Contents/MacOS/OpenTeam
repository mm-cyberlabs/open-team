#!/bin/bash

# Get the directory where this script is located
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
APP_ROOT="$DIR/.."
JAVA_DIR="$APP_ROOT/Java"

# Set up logging
LOG_DIR="$HOME/.openteam/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/openteam-$(date +%Y%m%d-%H%M%S).log"

echo "=== OpenTeam macOS App Launcher ===" >> "$LOG_FILE"
echo "Launch Time: $(date)" >> "$LOG_FILE"
echo "Script Location: $0" >> "$LOG_FILE"
echo "APP_ROOT: $APP_ROOT" >> "$LOG_FILE"
echo "JAVA_DIR: $JAVA_DIR" >> "$LOG_FILE"

# Use Java 21 explicitly
JAVA_CMD="/Library/Java/JavaVirtualMachines/jdk-21.0.8.jdk/Contents/Home/bin/java"
if [ ! -f "$JAVA_CMD" ]; then
    echo "Java 21 not found at $JAVA_CMD, trying system java" >> "$LOG_FILE"
    JAVA_CMD="java"
fi

echo "Java Command: $JAVA_CMD" >> "$LOG_FILE"
"$JAVA_CMD" -version >> "$LOG_FILE" 2>&1

# Build module path with JavaFX JARs only  
MODULE_PATH="$JAVA_DIR/lib/javafx-base-21-mac-aarch64.jar:$JAVA_DIR/lib/javafx-controls-21-mac-aarch64.jar:$JAVA_DIR/lib/javafx-fxml-21-mac-aarch64.jar:$JAVA_DIR/lib/javafx-graphics-21-mac-aarch64.jar"

# Build classpath with main JAR and essential dependencies
CLASSPATH="$JAVA_DIR/OpenTeam-main.jar:$JAVA_DIR/lib/postgresql-42.7.1.jar:$JAVA_DIR/lib/HikariCP-5.1.0.jar:$JAVA_DIR/lib/jackson-dataformat-yaml-2.16.1.jar:$JAVA_DIR/lib/jackson-core-2.16.1.jar:$JAVA_DIR/lib/jackson-databind-2.16.1.jar:$JAVA_DIR/lib/jackson-datatype-jsr310-2.16.1.jar:$JAVA_DIR/lib/snakeyaml-2.2.jar:$JAVA_DIR/lib/jackson-annotations-2.16.1.jar:$JAVA_DIR/lib/slf4j-api-2.0.9.jar:$JAVA_DIR/lib/logback-classic-1.4.14.jar:$JAVA_DIR/lib/logback-core-1.4.14.jar"

echo "Module Path: $MODULE_PATH" >> "$LOG_FILE"
echo "Classpath: $CLASSPATH" >> "$LOG_FILE"

# Set up Java options
JAVA_OPTS="--module-path $MODULE_PATH --add-modules javafx.base,javafx.controls,javafx.fxml -Xmx1024m -Dfile.encoding=UTF-8 -Djava.awt.headless=false"

# Add macOS specific options
JAVA_OPTS="$JAVA_OPTS -Xdock:name=OpenTeam"
if [ -f "$APP_ROOT/Resources/OpenTeam.icns" ]; then
    JAVA_OPTS="$JAVA_OPTS -Xdock:icon=$APP_ROOT/Resources/OpenTeam.icns"
fi

echo "Java Options: $JAVA_OPTS" >> "$LOG_FILE"

# Launch the application
echo "Launching application..." >> "$LOG_FILE"
exec "$JAVA_CMD" $JAVA_OPTS -cp "$CLASSPATH" com.openteam.OpenTeamApplication "$@" >> "$LOG_FILE" 2>&1
